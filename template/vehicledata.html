from flask import Flask, render_template, request, jsonify
import sys
import os

# Add the project root to Python path
sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__))))

from src.pipline.prediction_pipeline import predict_insurance_response

app = Flask(__name__)

@app.route('/')
def home():
    return render_template('vehicledata.html')

@app.route('/predict', methods=['POST'])
def predict():
    try:
        # Get form data
        data = {
            'Gender': request.form['Gender'],
            'Age': int(request.form['Age']),
            'Driving_License': int(request.form['Driving_License']),
            'Region_Code': float(request.form['Region_Code']),
            'Previously_Insured': int(request.form['Previously_Insured']),
            'Vehicle_Age': request.form['Vehicle_Age'],
            'Vehicle_Damage': request.form['Vehicle_Damage'],
            'Annual_Premium': float(request.form['Annual_Premium']),
            'Policy_Sales_Channel': float(request.form['Policy_Sales_Channel']),
            'Vintage': int(request.form['Vintage'])
        }
        
        # Make prediction
        result = predict_insurance_response(**data)
        
        # Format result
        prediction_text = "Interested in Vehicle Insurance" if result['prediction'] == 1 else "Not Interested in Vehicle Insurance"
        confidence = f"{result['probability'] * 100:.2f}%"
        
        return render_template('vehicledata.html', 
                             context=prediction_text,
                             confidence=confidence,
                             prediction=result['prediction'])
    
    except Exception as e:
        return render_template('vehicledata.html', 
                             context=f"Error: {str(e)}")

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)